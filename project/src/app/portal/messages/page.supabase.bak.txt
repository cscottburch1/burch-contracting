'use client';

import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/contexts/AuthContext';
import { supabase } from '@/lib/supabase';
import { Card } from '@/components/ui/Card';
import { Icon } from '@/components/ui/Icon';
import { Button } from '@/components/ui/Button';
import { Badge } from '@/components/ui/Badge';
import type { Message } from '@/types/crm';
import Link from 'next/link';

type PortalMessage = {
  id: string | number;
  sender_type: 'admin' | 'customer' | string;
  sender_name?: string;
  is_read: boolean;
  subject?: string;
  message?: string;
  body?: string;
  created_at?: string;
  [key: string]: any;
};

export default function MessagesPage() {
  const router = useRouter();
  const { user, customer, loading: authLoading } = useAuth();
  const [messages, setMessages] = useState<PortalMessage[]>([]);
  const [newMessage, setNewMessage] = useState('');
  const [subject, setSubject] = useState('');
  const [loading, setLoading] = useState(true);
  const [sending, setSending] = useState(false);

  useEffect(() => {
    if (!authLoading && !user) {
      router.push('/portal/login');
    }
  }, [user, authLoading, router]);

  useEffect(() => {
    if (customer) {
      loadMessages();
    }
  }, [customer]);

  const loadMessages = async () => {
    if (!customer) return;

    try {
      const { data, error } = await supabase
        .from('messages')
        .select('*')
        .eq('customer_id', customer.id)
        .order('created_at', { ascending: false });

      if (error) throw error;
      if (data) {
        const messagesData = (data as PortalMessage[]) || [];
setMessages(messagesData);

const unreadIds = messagesData
  .filter((m: PortalMessage) => !m.is_read && m.sender_type === 'admin')
  .map((m: PortalMessage) => m.id);

        if (unreadIds.length > 0) {
          await supabase
            .from('messages')
            .update({ is_read: true })
            .in('id', unreadIds);
        }
      }
    } catch (error) {
      console.error('Error loading messages:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleSend = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!customer || !newMessage.trim()) return;

    setSending(true);

    try {
      const { error } = await supabase
        .from('messages')
        .insert([
          {
            customer_id: customer.id,
            sender_type: 'customer',
            sender_name: customer.name,
            subject: subject.trim() || null,
            content: newMessage.trim(),
          },
        ]);

      if (error) throw error;

      setNewMessage('');
      setSubject('');
      await loadMessages();
    } catch (error) {
      console.error('Error sending message:', error);
    } finally {
      setSending(false);
    }
  };

  if (authLoading || loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Loading messages...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-gray-100">
      <div className="bg-white shadow-sm border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div className="flex items-center gap-4">
            <Link href="/portal" className="text-blue-600 hover:text-blue-700">
              <Icon name="ArrowLeft" size={24} />
            </Link>
            <h1 className="text-2xl font-bold text-gray-900">Messages</h1>
          </div>
        </div>
      </div>

      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <Card padding="lg" className="mb-6">
          <h2 className="text-lg font-bold text-gray-900 mb-4">Send a Message</h2>
          <form onSubmit={handleSend} className="space-y-4">
            <div>
              <label htmlFor="subject" className="block text-sm font-semibold text-gray-700 mb-2">
                Subject (Optional)
              </label>
              <input
                type="text"
                id="subject"
                value={subject}
                onChange={(e) => setSubject(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="What's this about?"
              />
            </div>
            <div>
              <label htmlFor="message" className="block text-sm font-semibold text-gray-700 mb-2">
                Message
              </label>
              <textarea
                id="message"
                value={newMessage}
                onChange={(e) => setNewMessage(e.target.value)}
                rows={4}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Type your message here..."
                required
              />
            </div>
            <Button type="submit" variant="primary" disabled={sending}>
              <Icon name="Send" size={20} />
              {sending ? 'Sending...' : 'Send Message'}
            </Button>
          </form>
        </Card>

        <div className="space-y-4">
          <h2 className="text-lg font-bold text-gray-900">Conversation History</h2>
          {messages.length === 0 ? (
            <Card padding="lg">
              <div className="text-center py-12">
                <Icon name="Mail" size={64} className="mx-auto mb-4 opacity-20 text-gray-400" />
                <h3 className="text-xl font-semibold text-gray-900 mb-2">No Messages Yet</h3>
                <p className="text-gray-600">Start a conversation by sending a message above.</p>
              </div>
            </Card>
          ) : (
            messages.map((message) => (
              <Card
                key={message.id}
                padding="lg"
                className={message.sender_type === 'admin' ? 'bg-blue-50' : ''}
              >
                <div className="flex items-start justify-between mb-2">
                  <div className="flex items-center gap-2">
                    <span className="font-semibold text-gray-900">{message.sender_name}</span>
                    <Badge color={message.sender_type === 'admin' ? 'blue' : 'gray'}>
                      {message.sender_type === 'admin' ? 'Business' : 'You'}
                    </Badge>
                  </div>
                  <span className="text-sm text-gray-500">
              {message.created_at ? new Date(message.created_at).toLocaleString() : ''}                    
	       </span>
                </div>
                {message.subject && (
                  <p className="font-semibold text-gray-800 mb-2">{message.subject}</p>
                )}
                <p className="text-gray-700 whitespace-pre-wrap">{message.content}</p>
              </Card>
            ))
          )}
        </div>
      </div>
    </div>
  );
}
